---
title: "NHANES"
author: "Junjie Hu and team"
date: "2023-11-20"
output: github_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, echo = FALSE}
library(haven)
library(tidyverse)
library(purrr)

```

## import NHANES datafiles
```{r}
demo_list = 
  list.files(path = "NHANES/DEMO", full.names = TRUE) 
hiv_list = 
  list.files(path = "NHANES/HIV", full.names = TRUE) 

load_files = function(x){
  
  filetype =
    str_extract(x, "DEMO|HIV")
  
  year = 
    str_extract(x, "(?<=_)[A-Z]")
  
data = 
    read_xpt(x) |>
    janitor::clean_names()|>
    mutate(filetype = filetype, year = year)
    
}


demo_list_output = 
  map(demo_list, load_files) 

hiv_list_output = 
  map(hiv_list, load_files) 

join_pair = function(df1, df2) {
  left_join(df1, df2, by = c("seqn", "year"))
}


joined_df = 
  map2(hiv_list_output, demo_list_output, ~join_pair(.x, .y))|>
  bind_rows()

```

Speacify `year`
```{r}
joined_df = 
  joined_df |>
  mutate(year = recode(year, "A" = "1999-2000",
                       "B" = "2001-2002",
                       "C" = "2003-2004",
                       "D" = "2005-2006",
                       "E" = "2007-2008",
                       "F" = "2009-2010",
                       "G" = "2011-2012",
                       "H" = "2013-2014",
                       "I" = "2015-2016",
                       "J" = "2017-2018"))
```

