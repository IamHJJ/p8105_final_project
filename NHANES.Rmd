---
title: "NHANES"
author: "Junjie Hu and team"
date: "2023-11-20"
output: html_document
editor_options: 
  chunk_output_type: inline
---

```{r setup, echo = FALSE}
library(haven)
library(tidyverse)
library(purrr)
library(plotly)
library(modelr)

```

## import NHANES datafiles

Imported demographic, HIV test, and sexual behavior dataframes 1999 - 2016. 
```{r}
demo_list = 
  list.files(path = "NHANES/DEMO", full.names = TRUE) 
hiv_list = 
  list.files(path = "NHANES/HIV", full.names = TRUE) 
sxq_list = 
  list.files(path = "NHANES/SXQ", full.names = TRUE) 


load_files = function(x){
  
  filetype =
    str_extract(x, "DEMO|HIV|SXQ")
  
  year = 
    str_extract(x, "(?<=_)[A-Z]")
  
data = 
    read_xpt(x) |>
    janitor::clean_names()|>
    mutate(filetype = filetype, year = year)
    
}


demo_list_output = 
  map(demo_list, load_files) 

hiv_list_output = 
  map(hiv_list, load_files) 

sxq_list_output = 
  map(sxq_list, load_files)

join_pair = function(df1, df2) {
  left_join(df1, df2, by = c("seqn", "year"))
}


hiv_demo_list = 
  map2(hiv_list_output, demo_list_output, ~join_pair(.x, .y))
  
hiv_demo_sxq_df = 
  map2(hiv_demo_list, sxq_list_output, ~join_pair(.x, .y)) |>
  bind_rows() 

```

Re-coded variables of interest:
Restricted particpants's age between 20 and 49
```{r}
cleaned_joined_df = 
  hiv_demo_sxq_df |>
  filter(ridageyr >= 20 & ridageyr <= 49) |>
  mutate(hiv = case_when(
    lbdhi == 1 | lbxhivc == 1 ~ 1,
    lbdhi == 2 | lbxhivc == 2 ~ 2)
    )|> 
  mutate(MSM = case_when(
    year %in% c("A","B","C") ~ sxq220,
    year %in% c("D","E","F","G","H","I") ~ sxq550)
    )|>
   mutate(WSW = case_when(
    year %in% c("A","B","C") ~ sxq150,
    year %in% c("D","E","F","G","H","I") ~ sxq490)
    )|>
  mutate(year = recode(year, 
                       "A" = "1999-2000",
                       "B" = "2001-2002",
                       "C" = "2003-2004",
                       "D" = "2005-2006",
                       "E" = "2007-2008",
                       "F" = "2009-2010",
                       "G" = "2011-2012",
                       "H" = "2013-2014",
                       "I" = "2015-2016"),
         hiv = recode(hiv,
                            "1" = "Reactive",
                            "2" = "Non-reactive"),
         gender = recode(riagendr, 
                         "1" = "Male",
                         "2" = "Female"),
         age = ridageyr,
         race = recode(ridreth1,
                       "1" = "Mexican American",
                       "2" = "Other Hispanic",
                       "3" = "Non-Hispanic White",
                       "4" = "Non-Hispanic Black",
                       "5" = "Other Race - Including Multi-Racial"),
         education = recode(dmdeduc2,
                            "1" = "Less than 9th grade",
                            "2" = "9-11th grade",
                            "3" = "High school graduate or equivalent",
                            "4" = "Some college or AA degree",
                            "5" = "College graduate or above",
                            "7" = NA_character_,
                            "9" = NA_character_),
         marriage = recode(dmdmartl,
                           "1" = "Married", 
                           "2" = "Widowed",
                           "3" = "Divorced",
                           "4" = "Separated",
                           "5" = "Never married",
                           "6" = "Living with partner",
                           "77" = NA_character_,
                           "99" = NA_character_)
         ) |>
  mutate(samesexcontact = case_when(
    (MSM %in% c(0, 7777, 77777,9999, 99999) | WSW %in% c(0, 7777, 77777, 9999, 99999)) ~ 0,
    (MSM >= 1 & MSM <= 600) | (WSW >= 1 & WSW <= 600) ~ 1
  )) |>
  select(seqn, hiv, age, gender, race, education, marriage, year, samesexcontact)
```

```{r}
cleaned_joined_df |>
  group_by(samesexcontact, hiv) |>
  summarize(n = n())
```

Visualization - 1
Total number as y-axis value
Across race
```{r}
cleaned_joined_df %>% 
  filter(hiv == "Reactive") %>% 
  group_by(race, gender) %>%
  summarize(n = n(), age_mean = round(mean(age), 2)) %>% 
  ungroup() %>% 
  mutate(race = fct_reorder(race, n)) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~race, y = ~n, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Race"),
      yaxis = list(title = "Total Number of HIV Positive Patients"),
      title = "The Total Number of HIV Positive Patients from 1999 to 2016 Across Races"
    )
  
```

Visualization - 1-1
Total percent as y-axis value
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(race, gender) %>%
  summarize(total_par = n(), age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(race = fct_reorder(race, hiv_percent)) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~race, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Race"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Races"
    )
```

Visualization 2: by year 
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(year, gender) %>% 
  summarize(age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~year, y = ~hiv_percent, color = ~gender, type = "scatter", mode = "lines+markers",
          text = ~text_label, colors = "viridis") %>% 
  layout(
      xaxis = list(title = "Year"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016"
    )
  
```

Visualization 3: 
Across Education level
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(education, gender) %>%
  summarize(total_par = n(), age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(education = forcats::fct_relevel(education, c("Less than 9th grade", "9-11th grade", 
                                         "High school graduate or equivalent", 
                                         "Some college or AA degree",
                                         "College graduate or above"))) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~education, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Education level"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Education Level"
    )
```


Visualization 4: 
Across marital status
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(marriage, gender) %>%
  summarize(total_par = n(), age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(marriage = fct_reorder(marriage, hiv_percent)) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~marriage, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Marital Status"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Marital Status"
    )
```


Visualization 5: Sexual behavior
```{r}
cleaned_joined_df %>%
  drop_na(hiv) %>% 
  mutate(samesexcontact = recode(samesexcontact, "0" = "No", 
                                  "1" = "Yes")) %>% 
  group_by(samesexcontact, gender) %>% 
  summarize(total_par = n(), age_mean = round(mean(age), 2), hiv_num = sum(hiv == "Reactive"),
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>% 
  ungroup() %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~samesexcontact, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Same Sex Sexual Behavior"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Sexual Behavior"
    )
```

Visualization 6: by year, stratified by education level instead of gender 
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(year, education) %>% 
  summarize(age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(education = forcats::fct_relevel(education, c("Less than 9th grade", "9-11th grade", 
                                         "High school graduate or equivalent", 
                                         "Some college or AA degree",
                                         "College graduate or above"))) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~year, y = ~hiv_percent, color = ~education, type = "scatter", mode = "lines+markers",
          text = ~text_label, colors = "viridis") %>% 
  layout(
      xaxis = list(title = "Year"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 by Education Level"
    )

```


Visualization 7: by year, stratified by race
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  group_by(year, race) %>% 
  summarize(age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(race = fct_reorder(race, hiv_percent)) %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~year, y = ~hiv_percent, color = ~race, type = "scatter", mode = "lines+markers",
          text = ~text_label, colors = "viridis") %>% 
  layout(
      xaxis = list(title = "Year"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 by Race"
    )

```


Visualization 8: by year, stratified by marital status
```{r}
cleaned_joined_df %>% 
  drop_na(hiv, marriage) %>% 
  group_by(year, marriage) %>% 
  summarize(age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~year, y = ~hiv_percent, color = ~marriage, type = "scatter", mode = "lines+markers",
          text = ~text_label, colors = "viridis") %>% 
  layout(
      xaxis = list(title = "Year"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 by Marital Status"
    )

```


Visualization 9: by year, stratified by Sexual behavior
```{r}
cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  mutate(samesexcontact = recode(samesexcontact, "0" = "No", 
                                  "1" = "Yes")) %>% 
  group_by(year, samesexcontact) %>% 
  summarize(age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv != "Reactive", hiv == "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~year, y = ~hiv_percent, color = ~samesexcontact, type = "scatter", mode = "lines+markers",
          text = ~text_label, colors = "viridis") %>% 
  layout(
      xaxis = list(title = "Year"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 by Sexual Behavior"
    )
```



# Visualization - Using function
## Prepare a new dataset only for Visualization
```{r}
cleaned_df_visual = 
  cleaned_joined_df %>% 
  drop_na(hiv) %>% 
  mutate(education = forcats::fct_relevel(education, c("Less than 9th grade", "9-11th grade", "High school graduate or equivalent", "Some college or AA degree", "College graduate or above")),
         samesexcontact = recode(samesexcontact, "0" = "No", 
                                  "1" = "Yes")
  )

cleaned_df_visual %>% 
  group_by(education, gender) %>%
  summarize(total_par = n(), age_mean = round(mean(age), 2), 
            hiv_percent = round(sum(hiv == "Reactive") / sum(hiv == "Reactive", hiv != "Reactive") * 100, 3)) %>%
  ungroup() %>% 
  mutate(text_label = str_c("mean age: ", age_mean)) %>% 
  plot_ly(x = ~education, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Race"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Races"
    )

```


## Write a function to draw bar plots
```{r}
draw_bar_plots = function(df, a) {
  df %>% 
    group_by(!!sym(a), gender) %>%
    summarize(
      total_par = n(),
      age_mean = round(mean(age), 2),
      hiv_percent = round(sum(hiv == "Reactive") / sum(hiv) * 100, 3)
    ) %>%
    ungroup() %>% 
    mutate(text_label = str_c("mean age: ", age_mean)) %>% 
    plot_ly(x = ~!!a, y = ~hiv_percent, color = ~gender, type = "bar", text = ~text_label, colors = "viridis") %>% 
    layout(
      xaxis = list(title = "Race"),
      yaxis = list(title = "Total Percent of HIV Positive Patients"),
      title = "The Total Percent of HIV Positive Patients from 1999 to 2016 Across Races"
    )
}

draw_bar_plots(cleaned_df_visual, "education")
```












## logistic regression

set the reference group
```{r}
cleaned_regression_df= 
   cleaned_joined_df |> 
   mutate(
      hiv_outcome = ifelse(hiv == "Reactive", 1, ifelse(hiv == "Non-reactive", 0, NA)),
      education = forcats::fct_relevel(education, c("Less than 9th grade", "9-11th grade", "High school graduate or equivalent", "Some college or AA degree", "College graduate or above")),
      race = forcats::fct_relevel(race, c("Non-Hispanic White", "Mexican American", "Non-Hispanic Black", "Other Hispanic", "Other Race - Including Multi-Racial")),
      marriage = forcats::fct_relevel(marriage, c("Married", "Widowed", "Divorced", "Separated", "Never married", "Living with partner"))
         )
```

This is the full model
```{r}
fit_alt = cleaned_regression_df |> 
  glm(hiv_outcome ~ samesexcontact + gender + age + race + education + marriage, data = _, family = binomial())
```

test `samesexcontact`, `gender`, `age`
```{r}
fit_alt|> 
  broom::tidy() |> 
  mutate(OR = exp(estimate)) |> 
  select(term, estimate, OR, p.value)
```
* `samesexcontact`, `gender`, `age` are all significant

test whether `race` is significant
```{r}
fit_no_race = 
  glm(hiv_outcome ~ samesexcontact + gender + age + education + marriage, data = na.omit(cleaned_regression_df), family = binomial())

anova(fit_no_race, fit_alt, test = 'LRT') |> broom::tidy()
  
```
* p = 0.00, `race` is significant


test whether `education` is significant
```{r}
fit_no_education = 
  glm(hiv_outcome ~ samesexcontact + gender + age + race + marriage, data = na.omit(cleaned_regression_df), family = binomial())

anova(fit_no_education, fit_alt, test = 'LRT') |> broom::tidy()
```
* p = 0.227, `education` is not significant

test whether `marriage` is significant
```{r}
fit_no_marriage = 
  glm(hiv_outcome ~ samesexcontact + gender + age + race + education, data = na.omit(cleaned_regression_df), family = binomial())

anova(fit_no_marriage, fit_alt, test = 'LRT') |> broom::tidy()
```
* p = 0.017, `marriage` is significant
* Therefore, the final model include `samesexcontact`, `gender`, `age`, `race`, `marriage`


The final model
```{r}
fit_regression = cleaned_regression_df |> 
  glm(hiv_outcome ~ samesexcontact + gender + age + race + marriage, data = _, family = binomial()) 

fit_regression|> 
  broom::tidy() |> 
  mutate(OR = exp(estimate)) |> 
  select(term, estimate, OR, p.value)|> 
  knitr::kable(digits = 3)
```

* Interpretation of results:


## Bootstrap

```{r}
bootstrap_df =
  cleaned_regression_df |> 
  bootstrap(n = 500) |> 
  mutate(
    models = map(.x = strap, ~glm(hiv_outcome ~ samesexcontact + gender + age + race + marriage, data = .x, family = binomial()) ),
    results = map(models, broom::tidy)) |> 
  select(-strap, -models) |> 
  unnest(results) |> 
  group_by(term) |> 
  mutate(OR = exp(estimate))
```


Look at the distribution of estimates under repeated sampling
```{r}
bootstrap_df|> 
  filter(term == "age") |> 
  ggplot(aes(x = estimate))+
  geom_density() +
  facet_wrap(.~ term)  
    
bootstrap_df|> 
  filter(term != "age") |> 
  ggplot(aes(x = estimate))+
  geom_density() +
  facet_wrap(.~ term)
```

* This is the uncertainty that we would get in this dataset if we do repeated sampling


Compute bootstrap mean OR and 95% CI 
```{r}
bootstrap_df|> 
  summarize(
    mean_OR = mean(OR),
    CI_lower = quantile(OR, 0.025),
    CI_upper = quantile(OR, 0.975)
    )|> 
  knitr::kable(digits = 3)
```
