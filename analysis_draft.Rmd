---
title: "HIV/AIDS Surveillance Data Analysis"
author: "Xuan Lu and Team"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    css: style.css
editor_options: 
  chunk_output_type: console
---

## Project Proposal Summary

### The Team
- Junjie Hu (jh4617)
- Ruixi Li (rl33298)
- Xuan Lu (xl3214)
- Tianyun Jiang (tj2519)
- Qinting Shen (qs2261)

### Tentative Project Title
HIV/AIDS Surveillance Data Analysis across Countries

### Motivation
The primary goal is to analyze information on HIV prevalence, incidence rates, and AIDS mortality from available studies, identifying the most vulnerable gender, sub-population, and geographic region.

### Intended Final Products
Multiple dashboards/web pages reflecting the prevalence and incidence rates of HIV across countries and subgroups.

### Anticipated Data Sources
United States Censusâ€™s HIV/AIDS Surveillance Data Base

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```




## Data Cleaning and Preparation

```{r clean data}
# Incidence

incidence <- read.csv("surveillance/data/hiv_incidence.csv") |>
  janitor::clean_names() |>
  select(-c(no_cases,no_deaths,prev_rate))

# prevalence

prevalence <- read.csv("surveillance/data/hiv_prevalence.csv") |>
  janitor::clean_names() |>
  select(-c(no_cases,no_deaths,inc_rate))
```

## Exploratory Analysis
```{r EDA}
# Histogram for HIV incidences

incidence |>
  ggplot(aes(x = inc_rate)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# add a small constant 0.01 to each value and conduct log transformation

log_inc = log(pull(incidence,inc_rate)+0.01)

incidence |>
  ggplot(aes(x = log_inc)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# Histogram for HIV prevalences

POR = log(pull(prevalence,prev_rate)/(1-pull(prevalence,prev_rate)))
prevalence |>
  ggplot(aes(x = prev_rate)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# add a small constant 0.01 to each value and conduct log transformation

log_prev = log(pull(prevalence,prev_rate)+0.01)

prevalence |>
  ggplot(aes(x = log_prev)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")


tri = (pull(prevalence,prev_rate))^(1/2)

prevalence |>
  ggplot(aes(x = tri)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")
```

## Statistical Testing
```{r Stat Tests}
# Load necessary libraries
library(broom)  # For tidy statistical summaries

# Chi-square test for categorical variables (e.g., gender)
chi_sq_result <- chisq.test(hiv_df_filtered$sex, hiv_df_filtered$inc_rate)
print(glue::glue("Chi-Square Test for Gender and HIV Incidences:\n"))
print(tidy(chi_sq_result))

# ANOVA for numeric variables (e.g., age)
aov_result <- aov(num_of_deaths ~ age, data = hiv_df_filtered)
print(glue::glue("\nANOVA for AIDS Mortality by Age:\n"))
print(tidy(aov_result))

# T-test (e.g., comparing two age groups)
# Ensure 'age_group' is a valid variable in your dataset
t_test_result <- t.test(num_of_deaths ~ age, data = hiv_df_filtered)
print(glue::glue("\nT-Test for AIDS Mortality by Age Group:\n"))
print(tidy(t_test_result))

# Regression (e.g., multiple variable regression)
lm_result <- lm(num_of_deaths ~ age + sex + geographic_area, data = hiv_df_filtered)
print(glue::glue("\nLinear Regression for AIDS Mortality:\n"))
print(tidy(lm_result))
```

- Chi-Square Test: Used for testing relationships between categorical variables.
- ANOVA: Analyzes differences between group means and their associated procedures.
- T-Test: Compares the means of two groups.
- Linear Regression: Models the relationship between a dependent variable and one or more independent variables.

### Validation of Data:

- Ensure hiv_df_filtered contains the necessary columns (gender, new_hiv_incidences, aids_mortality, age, age_group, geographic_region).
- Validate the assumptions for each statistical test (e.g., normality for t-test and ANOVA, independence for Chi-square).

## Visualization
```{r visualization}
library(plotly)
library(ggplot2)

# HIV Prevalence and Incidence Rates by Country

int_country = incidence |>
  plot_ly(x = ~country, y = ~inc_rate, name = 'Incidence Rate', type = 'bar') |> 
  layout(title = 'HIV Incidence Rates by Country', barmode = 'group')
int_country


prev_country = prevalence |>
  plot_ly(x = ~country, y = ~prev_rate, name = 'Incidence Rate', type = 'bar') |> 
  layout(title = 'HIV Prevalence Rates by Country', barmode = 'group')
prev_country

incidence |>
  mutate(country = as.factor(country),
         country = fct_reorder(country, inc_rate)) 
           plot_ly(x = ~country, y = ~inc_rate, name = 'Incidence Rate', type = 'bar') 

|>
    add_trace(x = ~country, y = ~prev_rate, name = 'Prevalence Rate', type = 'bar') |>
    layout(title = 'HIV Prevalence and Incidence Rates by Country',
           barmode = 'group')

print(country_plot)


# HIV Prevalence and Incidence Rates of Each Subpopulation Over Time


incidence |>
  group_by(sex) |>
  ggplot(aes(x = a, color = sex)) + geom_histogram(alpha=0.5)
incidence |>
  group_by(sex) |>
  summarize(median=median(inc_rate),iqr=IQR(inc_rate))

circumcise_plot = 
  incidence |>
  filter(population_subgroup %in% c('Adults - circumcised','Adults - uncircumcised')) |>
  group_by(population_subgroup) |>
  summarize(median=median(inc_rate),iqr=IQR(inc_rate), n=n()) |>
  ggplot(aes(x = ))
time_subpop_plot <- plot_ly(data = hiv_df_filtered) |>
    add_trace(x = ~year, y = ~inc_rate, color = ~population_subgroup, type = 'scatter', mode = 'lines', name = 'Incidence Rate') |>
    add_trace(x = ~year, y = ~prev_rate, color = ~population_subgroup, type = 'scatter', mode = 'lines', name = 'Prevalence Rate') |>
    layout(title = 'HIV Prevalence and Incidence Rates of Each Subpopulation Over Time')

print(time_subpop_plot)


# Difference in HIV Prevalence and Incidence Rates Across Gender
gender_plot <- ggplot(hiv_df_filtered, aes(x = sex)) +
    geom_bar(aes(y = inc_rate, fill = 'Incidence Rate'), stat = 'identity') +
    geom_bar(aes(y = prev_rate, fill = 'Prevalence Rate'), stat = 'identity', position = 'dodge') +
    theme_minimal() +
    labs(title = 'Difference in HIV Prevalence and Incidence Rates Across Gender')

print(gender_plot)
```

## Tables
```{r Tables}
# Load necessary libraries
library(dplyr)
library(knitr)

# Top Countries/Regions with Highest HIV Prevalences and Incidence Rates
top_countries <- hiv_df_filtered |>
    dplyr::group_by(country) |>
    dplyr::summarize(
        Average_Incidence = mean(inc_rate, na.rm = TRUE),
        Average_Prevalence = mean(prev_rate, na.rm = TRUE)
    ) |>
    dplyr::arrange(desc(Average_Incidence), desc(Average_Prevalence)) |>
    head(10)

# Display the table with kable for a professional look
kable(top_countries, caption = "Top 10 Countries/Regions with Highest HIV Incidence Rates", 
      format = "html", table.attr = "style='width:100%;'", 
      col.names = c("Country/Region", "Average Incidence Rate"))

unique(hiv_df$age)
```




