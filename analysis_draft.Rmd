---
title: "HIV/AIDS Surveillance Data Analysis"
author: "Xuan Lu and Team"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: yeti
    css: style.css
editor_options: 
  chunk_output_type: console
---

## Project Proposal Summary

### The Team
- Junjie Hu (jh4617)
- Ruixi Li (rl33298)
- Xuan Lu (xl3214)
- Tianyun Jiang (tj2519)
- Qinting Shen (qs2261)

### Tentative Project Title
HIV/AIDS Surveillance Data Analysis across Countries

### Motivation
The primary goal is to analyze information on HIV prevalence, incidence rates, and AIDS mortality from available studies, identifying the most vulnerable gender, sub-population, and geographic region.

### Intended Final Products
Multiple dashboards/web pages reflecting the prevalence and incidence rates of HIV across countries and subgroups.

### Anticipated Data Sources
United States Censusâ€™s HIV/AIDS Surveillance Data Base

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```




## Data Cleaning and Preparation

```{r clean data}
# Incidence

incidence <- read.csv("surveillance/data/hiv_incidence.csv") |>
  janitor::clean_names() |>
  select(-c(no_cases,no_deaths,prev_rate)) |>
  rename(subpop = subpop)

# prevalence

prevalence <- read.csv("surveillance/data/hiv_prevalence.csv") |>
  janitor::clean_names() |>
  select(-c(no_cases,no_deaths,inc_rate))|>
  rename(subpop = subpop)
```

## Exploratory Analysis
```{r EDA}
# Histogram for HIV incidences

incidence |>
  ggplot(aes(x = inc_rate)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# add a small constant 0.01 to each value and conduct log transformation

log_inc = log(pull(incidence,inc_rate)+0.01)

incidence |>
  ggplot(aes(x = log_inc)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# Histogram for HIV prevalences

POR = log(pull(prevalence,prev_rate)/(1-pull(prevalence,prev_rate)))
prevalence |>
  ggplot(aes(x = prev_rate)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")

# add a small constant 0.01 to each value and conduct log transformation

log_prev = log(pull(prevalence,prev_rate)+0.01)

prevalence |>
  ggplot(aes(x = log_prev)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")


tri = (pull(prevalence,prev_rate))^(1/2)

prevalence |>
  ggplot(aes(x = tri)) + geom_histogram(binwidth = 1, fill = "blue", color = "black")
```

## Statistical Testing
```{r Stat Tests}
# Load necessary libraries
library(broom)  # For tidy statistical summaries

# Chi-square test for categorical variables (e.g., gender)
chi_sq_result <- chisq.test(hiv_df_filtered$sex, hiv_df_filtered$inc_rate)
print(glue::glue("Chi-Square Test for Gender and HIV Incidences:\n"))
print(tidy(chi_sq_result))

# ANOVA for numeric variables (e.g., age)
aov_result <- aov(num_of_deaths ~ age, data = hiv_df_filtered)
print(glue::glue("\nANOVA for AIDS Mortality by Age:\n"))
print(tidy(aov_result))



# Regression (e.g., multiple variable regression)
lm_result <- lm(num_of_deaths ~ age + sex + geographic_area, data = hiv_df_filtered)
print(glue::glue("\nLinear Regression for AIDS Mortality:\n"))
print(tidy(lm_result))

# t test: Difference in HIV incidence rate between the circumcised and uncircumcised 

circumcise = 
  incidence |>
  mutate(
    subpop = recode(subpop,
                                 'Adults - circumcised' = 'circumcised',
                                 'Adults - uncircumcised' = 'uncircumcised')) |>
  filter(subpop %in% c('circumcised','uncircumcised'))

circumcise_plot = circumcise |>
  plot_ly(x = ~subpop, y = ~inc_rate, type = 'box') |>
  
circumcise_plot
ttest_result = t.test(inc_rate ~ subpop, data = circumcise) |> broom::tidy()
print(glue::glue("\nT-Test for HIV incidence by circumcision status among adults:\n"))
print(ttest_result)

```
According to the results of ttest, we have sufficient evidence to conclude that there's difference in incidence rate between the circumcised and uncircumcised adults. the uncircumcised adults are more likely to get HIV compared with the circumcised adults.





- Chi-Square Test: Used for testing relationships between categorical variables.
- ANOVA: Analyzes differences between group means and their associated procedures.
- T-Test: Compares the means of two groups.
- Linear Regression: Models the relationship between a dependent variable and one or more independent variables.

### Validation of Data:

- Ensure hiv_df_filtered contains the necessary columns (gender, new_hiv_incidences, aids_mortality, age, age_group, geographic_region).
- Validate the assumptions for each statistical test (e.g., normality for t-test and ANOVA, independence for Chi-square).

## Visualization
```{r visualization}
library(plotly)
library(ggplot2)

# HIV Prevalence and Incidence Rates by Country

inc_country = incidence |>
  group_by(country) |>
  summarize(median = median(inc_rate)) |>
  mutate(country = fct_reorder(country, median)) |>
  plot_ly(x = ~country, y = ~median, type = 'scatter', mode = 'markers') |> 
  layout(title = 'HIV Incidence Rates by Country',
         yaxis = list(title = 'Incidence Rate(%)'))
inc_country


prev_country = prevalence |>
  group_by(country) |>
  summarize(median = median(prev_rate)) |>
  mutate(country = fct_reorder(country, median)) |>
  plot_ly(x = ~country, y = ~median, type = 'scatter', mode = 'markers') |> 
  layout(title = 'HIV Prevalence Rates by Country',
         yaxis = list(title = 'Prevalence Rate(%)'))
prev_country


# HIV Prevalence and Incidence Rates of Each Subpopulation Over Time
# sexually active, TB, STI : other non-representative
# pregnant women: other patients
#sex worker&clients: ?

incidence = incidence |>
  mutate(
    subpop_pooled = ifelse(
     str_detect(subpop, "(?i)police|military"), "Military/Armed Forces",
     ifelse(
       str_detect(subpop, "(?i)child|pediatric"), "Children",
     ifelse(
       str_detect(subpop, "(?i)drug|IVDU") & !str_detect(subpop, "(?i)STI|homo|prisoner|partner|sex worker"),  "Intravenous Drug Users/Needle Sharers",
     ifelse(
       str_detect(subpop, "(?i)sex worker|bar") & !str_detect(subpop,"(?i)trans|IVDU|homo|MSM|drug|client"),"Sex workers",
     ifelse(
       str_detect(subpop, "(?i)transgender|homo|MSM|gay|TB|STI|sexually|prisoner|infants born|HIV2+|high risk") & !str_detect(subpop, "(?i)sex worker|IVDU|drug|Testing center attendees"), "Other Non-Representative",
      ifelse(
       str_detect(subpop, "(?i)pts.|pregnant|Mothers") & !str_detect(subpop, "(?i)sex worker|IVDU|STI|homo|TB"), "Other Patients",
      ifelse(
       str_detect(subpop, "(?i)Blood|port|Testing center attendees|employer|contractor") , "Genereal Population","Two Known Mixed Groups"))))))))

#unique(incidence$subpop[str_detect(incidence$subpop,"patient")]) for categorization

incidence = incidence |>
  mutate(subpop_pooled = ifelse(subpop %in% c("Bisexuals","Clients of sex workers","High risk individuals","Partners of HIV+ individuals","Spouses of HIV+ individuals"),"Other Non-Representative",subpop_pooled),
         subpop_pooled = ifelse(subpop == "Sex workers & clients","Sex workers",subpop_pooled),
         subpop_pooled = ifelse(subpop %in% c("Heterosexuals","Adults","Individuals","Women","Various groups","Residents","Unspecified population","HIV- individuals"),"Other Non-Representative",subpop_pooled))


check=incidence |>
  filter(subpop_pooled != "Two Known Mixed Groups") |>
  group_by(subpop_pooled,subpop) |>
  summarise(n=n())
  
incidence|>
  filter(subpop_pooled == "Two Known Mixed Groups") 
     
 



time_subpop_plot <- plot_ly(data = hiv_df_filtered) |>
    add_trace(x = ~year, y = ~inc_rate, color = ~subpop, type = 'scatter', mode = 'lines', name = 'Incidence Rate') |>
    add_trace(x = ~year, y = ~prev_rate, color = ~subpop, type = 'scatter', mode = 'lines', name = 'Prevalence Rate') |>
    layout(title = 'HIV Prevalence and Incidence Rates of Each Subpopulation Over Time')

print(time_subpop_plot)


# Difference in HIV Prevalence and Incidence Rates Across Gender
prev_sex = prevalence |>
  group_by(sex) |>
  summarize(median=median(prev_rate), n = n()) |>
  mutate(text_label = str_c("Sex:", sex, " \nMedian:", median, " Sample Size:", n))

sex_plot = incidence |>
  group_by(sex) |>
  summarise(median = median(inc_rate), n = n()) |>
  mutate(text_label = str_c("Sex:", sex, " \nMedian:", median, " Sample Size:", n)) |>
  plot_ly(x = ~sex, y = ~median, size = ~n, type = 'scatter', mode = 'markers', name = 'Incidence Rate',text = ~text_label, hoverinfo = 'text') |>
  add_trace(data = prev_sex, x = ~sex, y = ~median, size = ~n, type = 'scatter', name = 'Prevalence Rate',text = ~text_label, hoverinfo = 'text') |>
  layout(title = 'Median Incidence and Prevalence Rates by Sex',
         xaxis = list(title = 'Sex'),
         yaxis = list(title = 'Median Rate'))

print(sex_plot)
```

## Tables
```{r Tables}
# Load necessary libraries
library(dplyr)
library(knitr)

# Top Countries/Regions with Highest HIV Prevalences and Incidence Rates
top_countries <- hiv_df_filtered |>
    dplyr::group_by(country) |>
    dplyr::summarize(
        Average_Incidence = mean(inc_rate, na.rm = TRUE),
        Average_Prevalence = mean(prev_rate, na.rm = TRUE)
    ) |>
    dplyr::arrange(desc(Average_Incidence), desc(Average_Prevalence)) |>
    head(10)

# Display the table with kable for a professional look
kable(top_countries, caption = "Top 10 Countries/Regions with Highest HIV Incidence Rates", 
      format = "html", table.attr = "style='width:100%;'", 
      col.names = c("Country/Region", "Average Incidence Rate"))

unique(hiv_df$age)
```




